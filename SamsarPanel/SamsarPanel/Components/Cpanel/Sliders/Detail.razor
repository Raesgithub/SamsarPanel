@page "/Cpanel/Slider/add"
@page "/Cpanel/Slider/edit/{Id:int}"

@using Application.Helpers
@using Domain.Models.panel
@using Domain.Data
@using Domain.Resourses
@inject ApplicationDbContext Db
@inject IWebHostEnvironment Env
@inject IJSRuntime js
@inject NavigationManager Nav
@rendermode InteractiveServer

<h3>@(CurrentSlider?.Id == 0 ? "افزودن اسلایدر جدید" : "ویرایش اسلایدر")</h3>
<EditForm Model="CurrentSlider" OnValidSubmit="SaveSlider" FormName="sliderform" Enhance>
    <DataAnnotationsValidator />

 <div class="row">
     <div class="col-md-4">
            <div class="card p-4 text-center" style="max-width:100%;">
                <img src="@PreviewImage" class="img-thumbnail" style="max-width:360px; max-height:360px;" />
            </div>

        </div>
    <div class="col-md-8">
            <div class="card p-4" style="max-width:100%;">
                <InputFile OnChange="HandleSelected" class="form-control" />

                <div class="mt-2">
                    <InputText @bind-Value="CurrentSlider.Alt" class="form-control" placeholder="متن جایگزین تصویر" />
                    <ValidationMessage For="() => CurrentSlider.Alt" />
                </div>

                <div class="mt-3">
                    <InputText @bind-Value="CurrentSlider.Title" class="form-control" placeholder="عنوان (اختیاری)" />
                    <ValidationMessage For="() => CurrentSlider.Title" />
                </div>

                <div class="mt-2">
                    <InputTextArea @bind-Value="CurrentSlider.Description" class="form-control" placeholder="توضیح (اختیاری)" />
                    <ValidationMessage For="() => CurrentSlider.Description" />
                </div>

                <div class="mt-2">
                    <InputText @bind-Value="CurrentSlider.LinkButton" class="form-control" placeholder="لینک دکمه (اختیاری)" />
                    <ValidationMessage For="() => CurrentSlider.LinkButton" />
                </div>

                <div class="col-md-6">
                    <label class="form-label">وضعیت انتشار</label>
                    <InputSelect @bind-Value="CurrentSlider.IsPublish" class="form-control">
                        <option value="true">منتشر شود</option>
                        <option value="false">عدم انتشار</option>
                    </InputSelect>
                </div>

                <div class="mt-5">
                    <button type="submit" class="btn btn-success btn-large mt-5 w-25 m-auto">
                        @(CurrentSlider.Id == 0 ? "ذخیره ......." : "ویرایش")
                    </button>
                </div>
            </div>

        </div>
</div>

        
    
    
</EditForm>

@code {
    [Parameter] public int? Id { get; set; }
    [SupplyParameterFromForm] public Slider CurrentSlider { get; set; } = new Slider();

    private IBrowserFile? selectedFile;
    private string PreviewImage = "/images/default.png";

    protected override async Task OnParametersSetAsync()
    {
        if (Id.HasValue)
        {
            CurrentSlider = await Db.Sliders.FindAsync(Id.Value) ?? new Slider();
            PreviewImage = "/cpanel/assets/images/sliders/" + CurrentSlider.ImageUrl ?? "/images/default.png";
        }
    }

    private async Task HandleSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        if (selectedFile != null)
        {
            var buffer = new byte[selectedFile.Size];
            using var stream = selectedFile.OpenReadStream(1024 * 1024 * 4);
            await stream.ReadAsync(buffer);
            PreviewImage = $"data:{selectedFile.ContentType};base64,{Convert.ToBase64String(buffer)}";
        }
        if (selectedFile == null)
        {
            await js.InvokeVoidAsync("toastError", "تصویری انتخاب کنید");
            return;
        }
    }

    private async Task SaveSlider()
    {
        if (selectedFile != null)
        {
            UploadFile uploadFile = new UploadFile();
            var res = await uploadFile.Upload(selectedFile, ConstantCpanel.pysicaly_image_slider_path, ConstantCpanel.image_Valid_Types);
            if (res.IsSuccess)
            {
                CurrentSlider.ImageUrl = $"{res.Filename}";
            }
            else
            {
                return;
            }
        }

        if (CurrentSlider.Id == 0)
        {
            Db.Sliders.Add(CurrentSlider);
            await Db.SaveChangesAsync();
            CurrentSlider = new Slider();
            PreviewImage = "/images/default.png";
            selectedFile = null;
            await js.InvokeVoidAsync("toast", "ذخیره شد");
        }
        else
        {
            Db.Sliders.Update(CurrentSlider);
            await Db.SaveChangesAsync();
            await js.InvokeVoidAsync("toast", "ویرایش شد");
            Nav.NavigateTo("/Cpanel/Slider/");
        }
    }
}
