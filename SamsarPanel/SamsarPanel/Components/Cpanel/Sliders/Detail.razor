@page "/Slider/add"
@page "/Slider/edit/{id:int}"

@using Application.Helpers
@using Domain.Models.panel
@using SamsarPanel.Client.ViewModels
@using Domain.Data
@using Domain.Models
@inject IWebHostEnvironment Env
@inject ApplicationDbContext Db

<h3>آپلود اسلایدر</h3>

<EditForm FormName="FormSlider" Enhance OnSubmit="SaveSlider">
<div class="card p-4" style="max-width:500px;">
    <InputFile OnChange="HandleSelected" />

    <div class="mt-3 text-center">
        <img src="@PreviewImage" style="max-width:100%; max-height:300px;" class="img-thumbnail" />
    </div>

    <div class="mt-3">
        <InputText @bind-Value="Title" class="form-control" placeholder="عنوان (اختیاری)" />
    </div>
    <div class="mt-2">
        <InputTextArea @bind-Value="Description" class="form-control" placeholder="توضیح (اختیاری)" />
    </div>

    <button class="btn btn-primary mt-3" @onclick="SaveSlider">ذخیره اسلایدر</button>
</div>
</EditForm>
@code {
    private IBrowserFile? selectedFile;
    private string PreviewImage = "/images/default.jpg";
    private string? Title;
    private string? Description;

    private void HandleSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;

        if (selectedFile != null)
        {
            // پیش‌نمایش عکس
            var format = "image/png";
            using var stream = selectedFile.OpenReadStream(1024 * 1024 * 15); // 15MB max
            var buffer = new byte[selectedFile.Size];
            stream.Read(buffer, 0, buffer.Length);
            PreviewImage = $"data:{format};base64,{Convert.ToBase64String(buffer)}";
        }
    }

    private async Task SaveSlider()
    {
        string imagePath = "/images/default.jpg";
        UploadFile uploadFile = new UploadFile();
        if (selectedFile != null)
        {
            var uploads = Path.Combine(Env.WebRootPath, "uploads");
            if (!Directory.Exists(uploads))
                Directory.CreateDirectory(uploads);

            var fileName = $"{Guid.NewGuid()}_{selectedFile.Name}";
            var filePath = Path.Combine(uploads, fileName);

            using var fs = new FileStream(filePath, FileMode.Create);
            await selectedFile.OpenReadStream().CopyToAsync(fs);

            imagePath = $"/uploads/{fileName}";
        }

        var slider = new  Slider
        {
            ImageUrl = imagePath,
            Title = string.IsNullOrEmpty(Title) ? null : Title,
            //LinkButton
            Description = string.IsNullOrEmpty(Description) ? null : Description
        };

        Db.Sliders.Add(slider);
        await Db.SaveChangesAsync();

        // ریست فرم
        selectedFile = null;
        PreviewImage = "/images/default.jpg";
        Title = null;
        Description = null;
    }
}
