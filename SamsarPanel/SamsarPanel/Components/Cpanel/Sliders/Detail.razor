@page "/Cpanel/Slider/add"
@page "/Cpanel/Slider/edit/{Id:int}"

@using Application.Helpers
@using Domain.Models.panel
@using Domain.Data
@using Domain.Resourses
@inject ApplicationDbContext Db
@inject IWebHostEnvironment Env
@rendermode InteractiveServer
<h3>@(CurrentSlider?.Id == 0 ? "افزودن اسلایدر جدید" : "ویرایش اسلایدر")</h3>

    <EditForm Model="CurrentSlider" OnValidSubmit="SaveSlider" FormName="sliderform" Enhance>
        <DataAnnotationsValidator />
        <div class="card p-4" style="max-width:500px;">
            <InputFile OnChange="HandleSelected" class="form-control" />

            <div class="mt-2">
                <InputText @bind-Value="CurrentSlider.Alt" class="form-control" placeholder="متن جایگزین تصویر" />
                <ValidationMessage For="() => CurrentSlider.Alt" />
            </div>

            <div class="mt-3 text-center">
                <img src="@PreviewImage" class="img-thumbnail" style="max-width:100%; max-height:300px;" />
            </div>

            <div class="mt-3">
                <InputText @bind-Value="CurrentSlider.Title" class="form-control" placeholder="عنوان (اختیاری)" />
                <ValidationMessage For="() => CurrentSlider.Title" />
            </div>

            <div class="mt-2">
                <InputTextArea @bind-Value="CurrentSlider.Description" class="form-control" placeholder="توضیح (اختیاری)" />
                <ValidationMessage For="() => CurrentSlider.Description" />
            </div>

            <div class="mt-2">
                <InputText @bind-Value="CurrentSlider.LinkButton" class="form-control" placeholder="لینک دکمه (اختیاری)" />
                <ValidationMessage For="() => CurrentSlider.LinkButton" />
            </div>

            <div class="form-check mt-3">
                <InputCheckbox @bind-Value="CurrentSlider.IsPublish" class="form-check-input" id="publishCheck" />
                <label class="form-check-label" for="publishCheck">انتشار</label>
            </div>

            <button type="submit" class="btn btn-success mt-3">ذخیره</button>
        </div>
    </EditForm>

@code {
    [Parameter] public int? Id { get; set; }
    [SupplyParameterFromForm] public Slider CurrentSlider { get; set; } = new Slider();


    private IBrowserFile? selectedFile;
    private string PreviewImage = "/images/default.jpg";
    //private bool IsLoaded = false;


    protected override async Task OnParametersSetAsync()
    {
        if (Id.HasValue)
        {
            CurrentSlider = await Db.Sliders.FindAsync(Id.Value) ?? new Slider();
            PreviewImage = CurrentSlider.ImageUrl ?? "/images/default.jpg";
        }
    }

    private async Task HandleSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        if (selectedFile != null)
        {
            var buffer = new byte[selectedFile.Size];
            using var stream = selectedFile.OpenReadStream(1024 * 1024 * 4);
            await stream.ReadAsync(buffer);
            PreviewImage = $"data:{selectedFile.ContentType};base64,{Convert.ToBase64String(buffer)}";
        }
    }

    private async Task SaveSlider()
    {
        if (selectedFile == null) return;

        UploadFile uploadFile = new UploadFile();
        var res = await uploadFile.Upload(selectedFile, ConstantCpanel.pysicaly_image_slider_path, ConstantCpanel.image_Valid_Types);
        if (res.IsSuccess)
            {
                CurrentSlider.ImageUrl = $"{res.Filename}";
            }
            else
            {
                //res.Message
                return;
            }

            
        

        if (CurrentSlider.Id == 0)
        {
            Db.Sliders.Add(CurrentSlider);
            await Db.SaveChangesAsync();
            CurrentSlider = new Slider();
            PreviewImage = "/images/default.jpg";
            selectedFile = null;
        }

        

    }
}
